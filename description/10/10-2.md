# 호출 서버

<br>

## 1. 호출 서버
<br>

    - API call을 하기 위한 임시 외부 서버
    - npm init으로 package.json 생성
    - npm i cookie-parser dotenv express express-session morgan nunjucks을 실행하여 필요한 패키지 설치
    - npm i axios(새로운 패키지)
    - npm i -D nodemon
    - config, models, passport, routes, views .env, app.js 구성

<br>

```javascript

router.get('/test', async (req, res, next) => { // 토큰 테스트 라우터
  try {
    if (!req.session.jwt) { // 세션에 토큰이 없으면 토큰 발급 시도
      const tokenResult = await axios.post('http://localhost:8002/v1/token', {
        clientSecret: process.env.CLIENT_SECRET,
      });
      if (tokenResult.data && tokenResult.data.code === 200) { // 토큰 발급 성공
        req.session.jwt = tokenResult.data.token; // 세션에 토큰 저장
      } else { // 토큰 발급 실패
        return res.json(tokenResult.data); // 발급 실패 사유 응답
      }
    }
    // 발급받은 토큰 테스트
    const result = await axios.get('http://localhost:8002/v1/test', {
      headers: { authorization: req.session.jwt },
    });
    return res.json(result.data);
  } catch (error) {
    console.error(error);
    if (error.response.status === 419) { // 토큰 만료 시
      return res.json(error.response.data);
    }
    return next(error);
  }
});

```

<br>

    - 1. 처음에는 token이 저장되어 있지 않기 때문에 API 서버로 토큰 발급 시도
    - 2. API 서버는 Domain 테이블에 clientSecret이 등록되어 있는지 확인 
    - 3. 등록되어 있으면 토큰을 발급, jwt.sign(payload, JWT_SECRET, option)
    - 4. 토큰이 발급되었으면 호출 서버는 세션에 토큰을 저장(req.session.jwt) 
    - 5. 발급받은 토큰을 테스트 하기 위해 API 서버에 토큰을 헤더에 담아 요청
    - 6. 토큰이 유효하거나 만료되지 않았으면 요청한 정보를 반환

<br>

***

<br>

## 2. 

<br>

```javascript



```

<br>

    - 

<br>

```javascript

// routes/index.js



```

<br>

    - 

<br>

***

<br>

## 3.

<br>

    - 

<br>

    - 
<br>

```javascript



```

<br>

    - 

<br>

```javascript



```

<br>

    -

<br>

***

<br>
